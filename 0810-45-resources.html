<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Interleaved Clicking Up Metronome</title>
<style>
  :root{--bg:#0f1117; --panel:#151926; --text:#e7ecf3; --muted:#a3adbd; --line:#232a3c; --field:#0e1322; --accent:#7bdcff; --good:#75e39a; --current:#27314f;}
  body.light{--bg:#f6f7fb; --panel:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --field:#ffffff; --accent:#0077ff; --good:#0ea5e9; --current:#e8f1ff;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; transition: background .25s, color .25s; overflow-x:hidden}
  h1{margin:0;padding:16px 16px 0;font-weight:800;font-size:28px;letter-spacing:.2px;color:var(--text)}
  .wrap{display:grid;grid-template-columns:2fr 1fr;gap:16px;padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.1)}
  .bd{padding:12px 14px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,select,button{width:100%;color:var(--text);background:var(--field);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:none}
  select{appearance:none;-webkit-appearance:none;-moz-appearance:none}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .btn{cursor:pointer;font-weight:600}
  .btn.acc{background:linear-gradient(135deg, color-mix(in oklab, var(--accent) 70%, #fff), var(--accent));color:#06101b;border:none}
  .btn.ghost{background:var(--field);border:1px solid var(--line)}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px;cursor:pointer}
  th,td{padding:8px 10px;text-align:left}
  thead th{position:sticky;top:0;background:var(--panel);z-index:1;color:var(--muted)}
  tbody tr{background:var(--panel);border:1px solid var(--line)}
  tbody tr.current{outline:2px solid var(--accent);background:var(--current)}
  
  .cyclepill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:color-mix(in oklab, var(--panel) 92%, var(--accent) 8%)}
  /* Pulse */
  .pulse-wrap{position:fixed;left:50%;top:24px;transform:translateX(-50%);pointer-events:none;z-index:9999}
  .pulse-dot{width:18px;height:18px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 0 color-mix(in oklab, var(--accent) 55%, transparent);opacity:0.0;margin:auto}
  .pulse-dot.boom{animation:pulse 320ms ease-out 1}
  @keyframes pulse{
    0%   {transform:scale(1); box-shadow:0 0 0 0 color-mix(in oklab, var(--accent) 55%, transparent); opacity:0.0;}
    10%  {opacity:1;}
    60%  {transform:scale(2.4); box-shadow:0 0 0 16px color-mix(in oklab, var(--accent) 15%, transparent); opacity:1;}
    100% {transform:scale(3.0); box-shadow:0 0 0 22px color-mix(in oklab, var(--accent) 5%, transparent); opacity:0;}
  }
  /* Volume slider edge-to-edge */
  input[type="range"].volrange{appearance:none;-webkit-appearance:none;width:100%;margin:0;padding:0;background:transparent;height:24px}
  input[type="range"].volrange:focus{outline:none}
  input[type="range"].volrange::-webkit-slider-runnable-track{height:6px;background:var(--line);border-radius:4px;border:none;margin:0}
  input[type="range"].volrange::-moz-range-track{height:6px;background:var(--line);border-radius:4px;border:none;margin:0}
  input[type="range"].volrange::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);border:none;margin-top:-4px}
  input[type="range"].volrange::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--accent);border:none}

/* tighten options row to fit three checkboxes on one line */




#cycleLabel { display:inline-block; text-align:center; width:100%; }


/* Tighter table layout: no extra stretch before tempo column */
#tbl{ width:auto; }
#tbl th:nth-child(1), #tbl td:nth-child(1){ width:56px; }           /* step */
#tbl th:nth-child(3), #tbl td:nth-child(3){ width:80px; text-align:right; } /* tempo */
#tbl td:nth-child(3){ padding-left:6px; } /* reduce space before tempo */

/* Checkbox row: keep boxes close to their labels, but increase space between groups */




@media (max-width: 700px){
  .wrap{
    display:grid;
    grid-template-columns: 1fr 1fr; /* keep two panels side by side */
    gap:12px;
    padding:12px;
    overflow-x:hidden; /* no horizontal scroll */
  }
}
/* Buttons + legend split */
.btnsRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:start;margin-top:10px}
.btnsRow .btns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btnsRow .keyLegend{font-size:12px;color:var(--muted);line-height:1.35}
.btnsRow .keyLegend code{background:var(--field);border:1px solid var(--line);padding:2px 6px;border-radius:6px}
@media (max-width: 760px){
  .btnsRow{grid-template-columns:1fr}
}

/* Bold legend title and make Generate span full row */
.btnsRow .keyLegend > div{ font-weight:700; }
.btnsRow .btns button:first-child{ grid-column:1 / -1; }

/* Evenly distribute the three checkbox groups across the panel */
.opts-inline{justify-content:space-between !important;width:100%}


/* Center the legend content under its column */
.btnsRow .keyLegend{text-align:center;justify-self:center}

/* 1) Center the table in the second panel */

.card:nth-of-type(2) table { margin: 0 auto; }

/* 2) Move checkboxes closer to their text */
 

/* Center only the table, keep other items full-width and above */
.card:nth-of-type(2) .bd > div[style*="overflow:auto"] table{ margin-left:auto; margin-right:auto; }




/* Stack cycle controls: buttons row, pill below */
.cyclebar{display:flex;flex-direction:column !important;align-items:center !important;gap:8px}
.cyclebar .left{display:flex;gap:10px;justify-content:center;width:100%}
.cyclebar .right{width:100%;text-align:center}

/* Uniform checkbox spacing */



/* Keep equal, tight spacing between checkbox and its text, even when text wraps */



/* Force ultra-tight, uniform spacing that overrides inline styles */
.opts-inline label{
  display:inline-grid !important;
  grid-auto-flow:column;
  grid-template-columns:auto 1fr;
  align-items:flex-start !important;
  gap:2px !important; /* ~50% tighter */
  line-height:1.22;
}
.opts-inline input[type="checkbox"]{
  margin:0 !important;
  margin-top:1px !important; /* subtle optical align */
}


/* Resources footer links */
.linksFoot{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
}
.linksFoot a{
  color:var(--accent);
  text-decoration:none;
  border-bottom:1px dotted color-mix(in oklab, var(--accent) 60%, transparent);
}
.linksFoot a:hover{ text-decoration:underline; }
.linksFoot .sep{ color:var(--muted); }
@media (max-width: 700px){
  .linksFoot{ font-size:12px; }
}
</style>
<style>
/* Remove bullets from keyboard legend */
.keyLegend ul, .keyLegend li { list-style: none !important; padding-left: 0 !important; margin-left: 0 !important; }

/* Hide Save/Reset buttons per user request */
#save, #reset { display: none !important; }

/* --- Mobile tweaks: prevent squish on narrow screens --- */
@media (max-width: 700px){
  /* Stack form rows vertically */
  .row{ grid-template-columns: 1fr !important; gap:10px }
  /* Make options list stack and fill width */
  .opts-inline{ flex-direction: column !important; align-items: stretch !important; gap:8px !important }
  .opts-inline label{ width:100% }
  /* Keep nav buttons readable and wrapping */
  .cyclebar .left{ flex-wrap: wrap; justify-content: center }
  .btnsRow{ grid-template-columns: 1fr; }
  .btnsRow .btns{ grid-template-columns: 1fr 1fr; gap:10px }
  /* Give inputs a bit more tappable area */
  input, select, button{ padding:12px 14px }
  /* Ensure the table area remains usable but not too tall on tiny screens */
  .card .bd > div[style*="overflow:auto"]{ max-height: 52vh !important }
}
/* Slightly larger breakpoint for very narrow phones */
@media (max-width: 380px){
  .btnsRow .btns{ grid-template-columns: 1fr; }
}
/* --- end mobile tweaks --- */


/* Prevent extreme squish by letting the grid be wider than viewport if needed */
.wrap{}
@media (min-width: 701px){ .wrap{} }


/* --- Mobile (no horizontal scroll, keep side-by-side) --- */
@media (max-width: 700px){
  /* Stack controls within the left card to use vertical space instead of width */
  .row{ grid-template-columns: 1fr !important; gap:8px }
  /* Make the volume row full width (already applied) */
  /* Options stack vertically and fill width */
  .opts-inline{ flex-direction: column !important; align-items: stretch !important; gap:6px !important }
  .opts-inline label{ width:100% }
  /* Buttons wrap neatly */
  .cyclebar .left{ flex-wrap: wrap; justify-content: center; gap:8px }
  .btnsRow{ grid-template-columns: 1fr; }
  .btnsRow .btns{ grid-template-columns: 1fr; gap:8px }
  /* Slightly reduce padding and font sizes to fit */
  .bd{ padding:10px }
  h1{ font-size:22px }
  input, select, button{ padding:10px 12px; font-size:14px }
  .keyLegend{ font-size:11px }
  table{ font-size:12px; width:100% }
  #tbl th:nth-child(1), #tbl td:nth-child(1){ width:44px; }
  #tbl th:nth-child(3), #tbl td:nth-child(3){ width:64px; }
  .card .bd > div[style*="overflow:auto"]{ max-height: 54vh !important }
}
/* --- end mobile (no horizontal scroll) --- */


/* --- Compact 2-row layout for right-panel nav on small screens --- */
@media (max-width: 700px){
  .cyclebar{
    display: grid !important;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    align-items: stretch;
  }
  /* Collapse wrappers so all four buttons can pack into the grid */
  .cyclebar .left{ display: contents !important; }
  /* Remove the inline margin on the second wrapper */
  .cyclebar .left[style]{ margin-top: 0 !important; }
  /* Make each nav button fill its grid cell */
  .cyclebar .left button{ width: 100%; }
  /* Tighter buttons for small screens */
  .cyclebar .left button.btn{ padding: 8px 10px; font-size: 13px; }
  /* Keep the cycle pill full-width on its own row */
  .cyclebar .right{ grid-column: 1 / -1; justify-self: center; }
}
/* --- end compact 2-row layout --- */


/* Keyboard shortcuts: move to bottom of right panel on small screens */
#legendMobile { display:none; }
@media (max-width: 700px){
  .keyLegend { display:none !important; }    /* hide original (left panel) */
  #legendMobile { 
    display:block !important; 
    font-size:12px; 
    color:var(--muted); 
    line-height:1.35; 
    margin-top:10px; 
    text-align:center;
  }
  #legendMobile code{
    background:var(--field);
    border:1px solid var(--line);
    padding:2px 6px;
    border-radius:6px;
  }
}


/* Mobile: show legend at bottom of right panel; hide desktop legend */
#legendMobileStatic{ display:none; }
@media (max-width: 700px){
  .keyLegend{ display:none !important; }
  #legendMobileStatic{
    display:block !important;
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
    margin-top:10px;
    text-align:center;
  }
  #legendMobileStatic code{
    background:var(--field);
    border:1px solid var(--line);
    padding:2px 6px;
    border-radius:6px;
  }
}


/* Hide legacy Save/Reset buttons */
#save, #reset { display: none !important; }

/* Make Start/Stop width match Generate (full grid width) */
.btnsRow .btns #startStopBtn{ grid-column: 1 / -1; }

#startStopBtn{ width:100%; }

/* Resources footer links */
.linksFoot{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
}
.linksFoot a{
  color:var(--accent);
  text-decoration:none;
  border-bottom:1px dotted color-mix(in oklab, var(--accent) 60%, transparent);
}
.linksFoot a:hover{ text-decoration:underline; }
.linksFoot .sep{ color:var(--muted); }
@media (max-width: 700px){
  .linksFoot{ font-size:12px; }
}


/* Subheader under the main title */
Lpx;
  color: var(--muted);
  letter-spacing: .2px;

  text-align: center;
}
@media (max-width: 700px){
  Kpx; 
  text-align: center;
}
}

</style>
<style>
/* Subheader tweak */
.subheader{
  padding: 4px 16px 8px;
  font-size: 14px;
  color: var(--muted);
  letter-spacing: .2px;
  text-align: left;
}
@media (max-width: 700px){
  .subheader{ font-size: 13px; text-align: center; }
}
</style>
<style>
/* Hide all legends on small screens */
@media (max-width: 700px){
  .keyLegend{ display:none !important; }
  #legendMobileStatic{ display:none !important; }
}
</style>
</head>
<body>
<h1>Interleaved Clicking Up Metronome</h1>
<div class="subheader" id="subheader"><strong>Thanks to Dr. Molly Gebrian!</strong><br/><strong>Please see Resource Links below.</strong></div>
<div aria-hidden="true" class="pulse-wrap"><div class="pulse-dot" id="pulse"></div></div>
<div class="wrap">
<div class="card">
<div class="bd">
<div class="row">
<div>
<label>Start Tempo</label>
<input id="start" max="400" min="10" type="number" value="75"/>
</div>
<div>
<label>Target Tempo</label>
<input id="target" max="400" min="10" type="number" value="150"/>
</div>
</div>
<div class="row">
<div>
<label>Step Size</label>
<input id="step" max="50" min="1" type="number" value="5"/>
</div>
<div>
<label>Cycles (1–15)</label>
<input id="cycles" max="15" min="1" type="number" value="7"/>
</div>
</div><div class="row"><div><label>Start segment (optional)</label><input id="startSeg" max="99" min="1" placeholder="blank = default" type="number"/></div><div></div></div>
<div class="row">
<div>
<label>Subdivision</label>
<select id="subdiv">
<option value="1">Quarters</option>
<option value="2">8th's</option>
<option value="3">Triplets</option>
<option value="4">16ths</option>
<option value="5">5's</option>
<option value="6">6's</option>
<option value="7">7's</option>
</select>
</div>
<div style="grid-column:1 / -1;">
<label>Volume: <span id="volVal">50</span></label>
<input class="volrange" id="volume" max="100" min="0" step="1" type="range" value="50"/>
</div>
</div>
<div class="btnsRow"><div class="btns">
<button class="btn ghost" id="gen">Generate</button>
<button class="btn ghost" id="save">Save Defaults</button>
<button class="btn ghost" id="reset">Reset Defaults</button>
<button aria-pressed="false" class="btn acc" id="startStopBtn">Start</button>
</div><div class="keyLegend"><div><u>Keyboard shortcuts</u></div><ul style="list-style:none; margin:8px 0 0 0; padding:0;"><li style="margin:4px 0;; list-style:none"><code>Space</code> = Start / Stop</li><li style="margin:4px 0;; list-style:none"><code>←</code> / <code>→</code> = Prev / Next Cycle</li><li style="margin:4px 0;; list-style:none"><code>↑</code> / <code>↓</code> = Prev / Next Step</li></ul></div></div>
<div class="opts-inline" style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap">
<label style="margin:0; font-size:12.5px; color:var(--text); display:flex; align-items:center"><input id="pulseToggle" type="checkbox"/>Visual pulse </label><label style="margin:0; font-size:12.5px; color:var(--text); display:flex; align-items:center"><input id="backwards" type="checkbox"/> Backwards mode</label><label style="margin:0; font-size:12.5px; color:var(--text); display:flex; align-items:center"><input id="limitTarget" type="checkbox"/>Do not exceed Target Tempo</label>
<label style="margin:0; font-size:12.5px; color:var(--text); display:flex; align-items:center"><input id="allowFullVolume" type="checkbox"/> Allow full volume (louder clicks)</label>
<label style="margin:0; font-size:12.5px; color:var(--text); display:flex; align-items:center"><input id="themeToggle" type="checkbox"/> Light theme</label>
</div>
</div>
</div>
<div class="card">
<div class="bd">
<div class="cyclebar">
<div class="left">
<button aria-label="Previous Cycle" class="btn ghost" id="prevCycle">◀ Cycle</button>
<button aria-label="Next Cycle" class="btn ghost" id="nextCycle">Cycle ▶</button>
</div>
<div class="left" style="margin-top:6px;">
<button aria-label="Previous Step" class="btn ghost" id="prevStepBtn">▲ Step</button>
<button aria-label="Next Step" class="btn ghost" id="nextStepBtn">Step ▼</button>
</div>
<div class="right">
<span class="cyclepill" id="cycleLabel">Cycle – / –</span>
</div>
</div>
<div style="overflow:auto;max-height:58vh">
<table id="tbl">
<thead>
<tr>
<th>step</th>
<th>segments</th>
<th>tempo</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
<div class="legendMobile" id="legendMobileStatic"><div><u>Keyboard shortcuts</u></div>
<ul style="list-style:none; margin:8px 0 0 0; padding:0;">
<li style="margin:4px 0;; list-style:none"><code>Space</code> = Start / Stop</li>
<li style="margin:4px 0;; list-style:none"><code>←</code> / <code>→</code> = Prev / Next Cycle</li>
<li style="margin:4px 0;; list-style:none"><code>↑</code> / <code>↓</code> = Prev / Next Step</li>
</ul></div>
<div class="linksFoot" id="resourcesLinks"><span>Resource Links:</span>
  <a href="https://nellsonic.github.io/icu-metronome/features.html" id="linkFeaturesGuide" rel="noopener" target="_blank">Features Guide</a> <span class="sep">•</span> <a href="#" id="linkWhyInterleaving" rel="noopener" target="_blank">Why Interleaving Works</a> <span class="sep">•</span> <a href="https://www.mollygebrian.com/" id="linkMollyGebrian" rel="noopener" target="_blank">Dr. Molly Gebrian</a> <span class="sep">•</span> <a href="mailto:justforthisaugustday@gmail.com?subject=ICU%20Metronome%20Feedback" id="linkEmail">Email feedback</a></div></div>
</div>
</div>
<script>

// --- Mobile: force top-of-page on first open ---
try{ if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; } }catch(_){}

function scrollToTopStrong(){
  try{
    // Clear any accidental focus that could trigger mobile keyboard scroll
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
  }catch(_){}
  try{
    window.scrollTo(0,0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
  }catch(_){}
  try{ requestAnimationFrame(()=>window.scrollTo(0,0)); }catch(_){}
  setTimeout(()=>{ try{ window.scrollTo(0,0); }catch(_){}} , 180);
  setTimeout(()=>{ try{ window.scrollTo(0,0); }catch(_){}} , 600);
}

// In case the page is restored from bfcache, re-assert top
window.addEventListener('pageshow', (e)=>{
  if (e && e.persisted) { scrollToTopStrong(); }
}, { once:false });
// --- end mobile scroll helpers ---

const byId = id => document.getElementById(id);
function log(){}
function clearLog(){}

// Stable versioned key: remembers settings across renames
const SCHEMA_VERSION = 3;
const STORE_KEY = "icu_metronome_confirmed_standard_v" + SCHEMA_VERSION;

function saveSettings(){
  const s = {
    start:+byId('start').value||75,
    target:+byId('target').value||150,
    step:+byId('step').value||5,
    cycles:Math.min(15, Math.max(1, +byId('cycles').value||7)),
    subdiv:+byId('subdiv').value||1,
    volume:Math.min(100, Math.max(0, +byId('volume').value||50)),
    pulse: !!byId('pulseToggle').checked,
    limitTarget: !!byId('limitTarget').checked,
    startSeg: (byId('startSeg')?.value ? +byId('startSeg').value : null),
    backwards: !!byId('backwards')?.checked,
    theme: byId('themeToggle').checked ? 'light' : 'dark',
    allowFullVolume: !!byId('allowFullVolume')?.checked,
    _v: SCHEMA_VERSION
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(s));
  return s;
}

function resetSettings(){ localStorage.removeItem(STORE_KEY); loadSettings(); generate(); }

function loadSettings(){
  let s;
  try{ s = JSON.parse(localStorage.getItem(STORE_KEY)||"{}"); }catch(_){
    s = {};
  }
  if(s._v !== SCHEMA_VERSION) s = {};
  byId('start').value  = s.start  ?? 75;
  byId('target').value = s.target ?? 150;
  byId('step').value   = s.step   ?? 5;
  byId('cycles').value = s.cycles ?? 7;
  byId('subdiv').value = s.subdiv ?? 1;
  byId('volume').value = (s.volume ?? 50);
  byId('volVal').textContent = String(Math.round(+byId('volume').value||50));
  byId('pulseToggle').checked = !!s.pulse;
  byId('limitTarget').checked = !!s.limitTarget;
  if(byId('startSeg')) byId('startSeg').value = (s.startSeg ?? '');
  byId('themeToggle').checked = (s.theme === 'light');
  if(byId('allowFullVolume')) byId('allowFullVolume').checked = !!s.allowFullVolume;
  applyTheme();
}

function applyTheme(){ document.body.classList.toggle('light', byId('themeToggle').checked); }

// Effective gain: limit to safe level unless full volume is allowed
function setEffectiveGainFromSlider(){
  const v = (+byId('volume').value||0);
  const allowFull = !!byId('allowFullVolume')?.checked;
  const raw = Math.max(0, Math.min(1, v/100));
  const SAFE_ATTEN = 0.4; // approx inverse of louder sample
  const eff = allowFull ? raw : (raw * SAFE_ATTEN);
  if(masterGain) masterGain.gain.value = eff;
}


// UI
byId('gen').addEventListener('click', generate);
byId('save').addEventListener('click', ()=>{ saveSettings(); });
byId('reset').addEventListener('click', resetSettings);
byId('startStopBtn').addEventListener('click', toggle);
byId('nextCycle').addEventListener('click', nextCycle);

byId('prevStepBtn').addEventListener('click', prevStep);
byId('nextStepBtn').addEventListener('click', nextStep);

byId('prevCycle').addEventListener('click', prevCycle);

byId('limitTarget').addEventListener('change', ()=>{ saveSettings(); generate(); });
byId('startSeg')?.addEventListener('change', ()=>{ saveSettings(); generate(); });
byId('backwards')?.addEventListener('change', ()=>{ saveSettings(); generate(); });

byId('themeToggle').addEventListener('change', ()=>{ applyTheme(); saveSettings(); });

byId('allowFullVolume')?.addEventListener('change', ()=>{ saveSettings(); setEffectiveGainFromSlider(); });


// Volume live
byId('volume').addEventListener('input', ()=>{
  const v = (+byId('volume').value||0);
  byId('volVal').textContent = String(Math.round(v));
  setEffectiveGainFromSlider();
});
byId('volume').addEventListener('change', ()=>{ byId('volume').blur(); });

// Avoid select trapping space
byId('subdiv').addEventListener('change', ()=>{ byId('subdiv').blur(); saveSettings(); if(isStarted) playCurrent(); });


function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
// Build contiguous block of size N around S by alternating add-right then add-left
function buildCycleSetAround(T, N, S){
  S = clamp(S,1,T);
  let L=S, R=S;
  while((R-L+1)<N){
    const size = (R-L+1);
    const wantRight = (size % 2) === 1; // 1->right,2->left,3->right...
    if (wantRight){ if(R<T) R++; else if(L>1) L--; else break; }
    else { if(L>1) L--; else if(R<T) R++; else break; }
  }
  const out=[]; for(let v=L; v<=R; v++) out.push(v);
  return out;
}

// Helpers
function segStr(a){ return a.join(","); }

function compressSegments(segStr){
  try{
    if(!segStr || typeof segStr !== 'string') return segStr;
    var parts = segStr.split(',').map(function(s){ return parseInt(s.trim(),10); }).filter(function(n){ return !isNaN(n); });
    if(parts.length === 0) return segStr;
    parts.sort(function(a,b){ return a-b; });
    var out = [];
    var runStart = parts[0];
    var prev = parts[0];
    for(var i=1;i<=parts.length;i++){
      var v = parts[i];
      if(i<parts.length && v === prev + 1){
        prev = v;
        continue;
      }
      // finalize the run [runStart..prev]
      var runLen = (prev - runStart + 1);
      if(runLen >= 4){
        out.push(runStart + '-' + prev);
      }else{
        for(var k=runStart; k<=prev; k++){ out.push(String(k)); }
      }
      if(i<parts.length){ runStart = prev = v; }
    }
    return out.join(',');
  }catch(_){
    return segStr;
  }
}


// Overshoot-friendly tempo ladder
function rangeTempos(start, target, step, limitToTarget){
  const dir = target>=start ? 1 : -1;
  const tempos = [];
  let t = start;
  tempos.push(t);

  if(!limitToTarget){
    // Original behavior with optional overshoot
    while ((dir>0 && t + dir*step <= target) || (dir<0 && t + dir*step >= target)){
      t += dir*step;
      tempos.push(t);
    }
    // add one overshoot step if not landing exactly on target
    if ((dir>0 && tempos[tempos.length-1] < target) || (dir<0 && tempos[tempos.length-1] > target)){
      tempos.push(tempos[tempos.length-1] + dir*step);
    }
    return tempos;
  }

  // limitToTarget=true: reduce the last step if needed so we end exactly on target and never exceed it
  while (true){
    const next = t + dir*step;
    if ((dir>0 && next > target) || (dir<0 && next < target)){
      // next would overshoot; finish exactly at target if we're not already there
      if (t !== target){ tempos.push(target); }
      break;
    } else {
      t = next;
      tempos.push(t);
      if (t === target) break;
    }
  }
  return tempos;
}

// Across pattern for cycles >=3
function buildAcrossSeq(N){
  const base = Array.from({length:N}, (_,i)=>i+1);
  const seq = [base.slice(), [N]];
  for(let k=N-1; k>=2; k--){
    seq.push(Array.from({length:N-k+1}, (_,i)=>k+i));
    seq.push([N]);
  }
  return seq;
}

// State
let allRows = [];
let cycleMap = new Map();
let currentCycle = 1;
let currentIndexInCycle = 0;

// Generator (confirmed standard rules)
function generate(){
  clearLog();
  const s = saveSettings();
  const tempos = rangeTempos(s.start, s.target, s.step, !!s.limitTarget);
  const finalTempo = tempos[tempos.length-1];
  const rows = [];
  cycleMap = new Map();

  for(let c=1; c<=s.cycles; c++){ 
    let stepIdx = 1; 

    if(c===1){
      // Only segment 1 = run full tempo list (may overshoot), no tail
      for(let i=0;i<tempos.length;i++){ rows.push({cycle:c, step:stepIdx++, segments:"1", tempo:tempos[i]}); }
    } else if(c===2){
      const patt = [[1,2],[2]]; const L = patt.length;
      for(let i=0;i<tempos.length;i++){ rows.push({cycle:c, step:stepIdx++, segments:segStr(patt[i%L]), tempo:tempos[i]}); }
      // Tail at finalTempo until next [1,2], unless already on [1,2]
      const j = (tempos.length - 1) % L;
      const landed = patt[j];
      const isAll = (landed.length===2 && landed[0]===1 && landed[1]===2);
      if(!isAll){
        let idx = (tempos.length) % L;
        while(true){
          const segs = patt[idx%L];
          rows.push({cycle:c, step:stepIdx++, segments:segStr(segs), tempo:finalTempo});
          if(segs.length===2 && segs[0]===1 && segs[1]===2) break;
          idx++;
        }
      }
    } else {
      const N = c;
      const baseAll = Array.from({length:N}, (_,i)=>i+1);
      const across = buildAcrossSeq(N); const L = across.length;
      for(let i=0;i<tempos.length;i++){ rows.push({cycle:c, step:stepIdx++, segments:segStr(across[i%L]), tempo:tempos[i]}); }
      // Tail at finalTempo until next [1..N], unless we already landed there
      const j = (tempos.length - 1) % L;
      const landed = across[j];
      const isAll = (landed.length===N && landed.every((v,ii)=>v===ii+1));
      if(!isAll){
        let idx = (tempos.length) % L;
        while(true){
          const segsArr = across[idx%L];
          rows.push({cycle:c, step:stepIdx++, segments:segStr(segsArr), tempo:finalTempo});
          const isAll2 = (segsArr.length===N && segsArr.every((v,ii)=>v===ii+1));
          if(isAll2) break;
          idx++;
        }
      }
    }

    // per-cycle index map
    const idxs = [];
    for(let i=0;i<rows.length;i++) if(rows[i].cycle===c) idxs.push(i);
    cycleMap.set(c, idxs);
  }

  
  
  // === Start segment spec mapping (identity vs reversed per cycle) ===
  if (byId('startSeg') && byId('startSeg').value){
    const T = +byId('cycles').value || 1;
    const startDisplay = clamp(+byId('startSeg').value, 1, T);
    // Work in forward coordinates first; if backwards is on, convert start to forward coordinate
    const backwardsOn = !!byId('backwards')?.checked;
    const S_forward = backwardsOn ? (T - startDisplay + 1) : startDisplay;

    // Precompute sets and mapping functions per cycle
    const cycleSet = new Map();
    const mapFn = new Map(); // v_local -> actual forward segment
    for(let c=1; c<=T; c++){
      const set = buildCycleSetAround(T, c, S_forward); // ascending forward numbers [L..R]
      cycleSet.set(c, set);
      const N = set.length;
      const newIsRight = (c===1) ? true : (c % 2 === 0); // c=1 maps identity so solo stays S; from c=2 even:right, odd:left
      if (newIsRight){
        // identity: local 1..N -> set[0..N-1]
        mapFn.set(c, (v)=> set[Math.max(1, Math.min(N, v)) - 1]);
      } else {
        // reversed: local 1..N -> set[N-v]
        mapFn.set(c, (v)=> set[N - Math.max(1, Math.min(N, v))]);
      }
    }

    // Remap each row's local indices to actual segments, then list ascending for play
    for (let r of rows){
      if (!r.segments || typeof r.segments !== 'string') continue;
      const c = r.cycle;
      const mapper = mapFn.get(c);
      if (!mapper) continue;
      const nums = r.segments.split(',').map(s=>+s.trim()).filter(n=>!isNaN(n));
      let mapped = nums.map(v => mapper(v));
      // Dedup + ascending listing for play
      mapped = Array.from(new Set(mapped)).sort((a,b)=>a-b);
      r.segments = mapped.join(',');
    }
  }

  // === Backwards post-process: mirror segment numbers and sort descending ===
  if (!!s.backwards) {
    const T = +s.cycles || 1;
    for (let r of rows) {
      if (r.segments && typeof r.segments === "string") {
        const nums = r.segments.split(",").map(x => +x.trim()).filter(n => !isNaN(n));
        const mapped = nums.map(v => (T - v + 1)).sort((a,b)=>a-b);
        r.segments = mapped.join(",");
      }
    }
  }

  allRows = rows;
  currentCycle = 1;
  currentIndexInCycle = 0;
  renderCycle();
}

function renderCycle(){
  // Force the table container to the top on cycle changes
  try{
    const tbl = byId('tbl');
    if (tbl){
      const wrap = tbl.closest('div');
      if (wrap && (wrap.scrollTop !== undefined)) wrap.scrollTop = 0;
    }
  }catch(_){/*noop*/}

  const idxs = cycleMap.get(currentCycle) || [];
  const tb = byId('tbody'); tb.innerHTML="";
  idxs.forEach((gi, i)=>{
    const r = allRows[gi];
    const tr = document.createElement('tr');
    tr.dataset.localIndex = i;
    var _segC = compressSegments(r.segments);
    tr.innerHTML = '<td>'+r.step+'</td><td title="'+r.segments+'">'+_segC+'</td><td>'+r.tempo+'</td>';
    tr.addEventListener('click', ()=>{ setCurrentIndexInCycle(i); if(isStarted) playCurrent(); });
    tb.appendChild(tr);
  });
  setCurrentIndexInCycle(0);
  byId('cycleLabel').textContent = `Cycle ${currentCycle} / ${byId('cycles').value}`;
}

function setCurrentIndexInCycle(i){
  const idxs = cycleMap.get(currentCycle) || [];
  if(idxs.length===0) return;
  i = Math.max(0, Math.min(idxs.length-1, i));
  currentIndexInCycle = i;
  const tb = byId('tbody');
  tb.querySelectorAll('tr').forEach(tr=>tr.classList.remove('current'));
  const tr = tb.querySelectorAll('tr')[i];
  if(tr){ tr.classList.add('current'); tr.scrollIntoView({block:'nearest'}); }
}

// Navigation
function nextStep(){
  const idxs = cycleMap.get(currentCycle) || [];
  if(idxs.length === 0) return;
  if(currentIndexInCycle < idxs.length - 1){
    setCurrentIndexInCycle(currentIndexInCycle + 1);
  } else {
    // at last step, move to first step of next cycle if possible
    const total = +byId('cycles').value || 1;
    if(currentCycle < total){
      currentCycle++;
      renderCycle();
      setCurrentIndexInCycle(0);
    }
  }
  if(isStarted) playCurrent();
}
function prevStep(){
  const idxs = cycleMap.get(currentCycle) || [];
  if(idxs.length === 0) return;
  if(currentIndexInCycle > 0){
    setCurrentIndexInCycle(currentIndexInCycle - 1);
  } else {
    // at first step, move to last step of previous cycle if possible
    if(currentCycle > 1){
      currentCycle--;
      renderCycle();
      const prevIdxs = cycleMap.get(currentCycle) || [];
      if(prevIdxs.length > 0){
        setCurrentIndexInCycle(prevIdxs.length - 1);
      }
    }
  }
  if(isStarted) playCurrent();
}
function nextCycle(){ const total = +byId('cycles').value||1; if(currentCycle < total){ currentCycle++; renderCycle(); if(isStarted) playCurrent(); } }
function prevCycle(){ if(currentCycle > 1){ currentCycle--; renderCycle(); if(isStarted) playCurrent(); } }

// === Audio (onset-aligned, master gain, hardwired keys) ===
let audioCtx=null, masterGain=null, mainBuf=null, subBuf=null, beatTimer=null, isStarted=false;
const MAIN_B64 = `UklGRkYEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YSIEAAAAADRk1H7/f/9//3//f/9//38Rf4xlTQMwnWuBAIAAgACAAIAAgACAs4ApmWb5XWFSfv9//3//f/9//3//f4R/E2joCSSg84EAgACAAIAAgACAAIBGgLmW0PJPXsN9/3//f/9//3//f/9/7H9ranIQUKOJggCAAIAAgACAAIAAgACAepRK7OhaDH3/f/9//3//f/9//3/xf3prZBZDqPSDAIAAgACAAIAAgACAVoC+lBjneVTwev9//3//f/9//3//f1p/+mpDG+GuSIYAgACAAIAAgACAAID9gFuVkuKzTV94/3//f/9//3//f/9/o34+anEfyrUZiQCAAIAAgACAAIAAgMWBOJa13qtGS3X/f/9//3//f/9//3/GfUJp/iLmvHWMAIAAgACAAIAAgACAt4JTl3vbgT+kcUZ//3//f/9//3//f7x8AWjlJRTEaJCLgQCAAIAAgACAAIDdg7iY5dhVOGNthn3/f/9//3//f/9/eXt2ZiwoPMv6lIaDAIAAgACAAIAAgEGFbZro1j0xf2hKe/9//3//f/9//3/weZdk4Ck40jGaCIYAgACAAIAAgCuA84Z7nIDVXir2Ynt4YX//f/9//38zfxF4WGL8KvPYCaAsiYSBAIAAgACAhIEEie2eqtTNI9Fc/HRzff9//3//f6t9yHWuX4grVd96pgyNvIN4gACAU4BDg4qL0qFl1KMdGla0cOd6mX6Wf9d+rXv9coxcgytI5XKtwpGmhn2CVIEfgoeFoY41pbTU7RfjToprk3c9fJV9wXwYeZRv4FjvKrrq37Rnl3CKO4Wug4yEd4hnki6pjtW8EkZHZ2VIcw151nrveb91aGuYVMkpp++kvAqeSI/tiOWG04dGjAOXy63/1hYOZT8/XtVtyHQWdyN2a3FSZqFPFSj/853EtaVkldiNQos3jDCRnZwhswHZDApdNxFWBWcnbwdyEHHaayVg50nEJcP3rcxirvKcRZQakQ+Sepdlo0W5nduZBk4v7EytXtdnTWteasFktVhTQ9wi5fqv1P23GqaJnNGYuJl1n4yrTsDS3sQDXCfjQrRUjF6CYqRh01vQT9Y7WB9o/YTcasLqsOimx6KVo2qpO7VIyKvijwGsHx04D0kMU0dXiVbGUE5FWzMvG0r/D+R5zVq9k7NTrwSwn7WSwELRIucAAFEY1CzeOzhFXkm8SGNDHDngKV8WjAA06+7YQcuLwp6+NL81xKDNPdtF7BH/YhFAIVktKzW6OCo4nTM9K2If5xAsAeTxkORJ2pHTidAV0RrVT9w35hLyvv70CqAV3h1GI6wlEyWwIc4b8hPGCiwBDPgm8BTqLeaV5Dnl7+dk7BfyiPgR/xUFKwrtDSoQ2BAWEBYOLQurBwIEjACh/Wz7Fvqa+ef50PoX/Hf9uf6d/w==`;
const SUB_B64  = `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`;
let onsetMainMs = 0, onsetSubMs = 0, alignMs = 0;

async function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = (+byId('volume').value||50)/100;
    masterGain.connect(audioCtx.destination);
  }
  if(audioCtx.state === "suspended"){ try{ await audioCtx.resume(); }catch(_ ){} }
}
async function decodeB64ToBuffer(b64){
  if(!b64) return null;
  try{
    const bin = atob(b64.trim());
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
    const buf = arr.buffer;
    return await new Promise((resolve,reject)=>{
      try{ audioCtx.decodeAudioData(buf.slice(0), b=>resolve(b), e=>reject(e)); }
      catch(e){ reject(e); }
    });
  }catch(_ ){ return null; }
}
function detectOnsetMs(buf){
  try{
    const ch = buf.getChannelData(0);
    let maxAbs = 0;
    for(let i=0;i<ch.length;i++){ const a = Math.abs(ch[i]); if(a>maxAbs) maxAbs=a; }
    const thr = Math.max(0.02, maxAbs*0.15);
    for(let i=0;i<ch.length;i++){ if(Math.abs(ch[i]) >= thr) return (i / buf.sampleRate) * 1000.0; }
  }catch(_ ){}
  return 0;
}
async function loadBuffers(){
  mainBuf = await decodeB64ToBuffer(MAIN_B64);
  subBuf  = await decodeB64ToBuffer(SUB_B64);
  onsetMainMs = mainBuf ? detectOnsetMs(mainBuf) : 0;
  onsetSubMs  = subBuf  ? detectOnsetMs(subBuf)  : 0;
  alignMs = Math.max(onsetMainMs, onsetSubMs);
}
// Fallback: if subdivision sample failed to decode, reuse main click so no beep
if(!subBuf && mainBuf){
  console.warn('[ICU] Subdivision sample failed to load; falling back to main click.');
  subBuf = mainBuf;
  onsetSubMs = onsetMainMs;
}

function playBuf(buf){
  if(buf){
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(masterGain);
    src.start();
  } else if (mainBuf) {
    // Last-resort: if we somehow got null here, use main click
    const src = audioCtx.createBufferSource();
    src.buffer = mainBuf;
    src.connect(masterGain);
    src.start();
  } else {
    // Only beep if we have no decoded buffers at all
    const osc = audioCtx.createOscillator();
    osc.type = "square"; osc.frequency.value = 2000;
    osc.connect(masterGain); osc.start(); setTimeout(()=>osc.stop(), 20);
  }
}
function msPerBeat(bpm, sub){ return 60000/(bpm*sub); }

async function playCurrent(){
  const idxs = cycleMap.get(currentCycle) || [];
  if(idxs.length===0) return;
  await ensureAudio();
  if(!mainBuf || !subBuf) await loadBuffers();
  if(beatTimer) clearInterval(beatTimer);
  const r = allRows[idxs[currentIndexInCycle]];
  const subdiv = Math.max(1, +byId('subdiv').value||1);
  const interval = msPerBeat(r.tempo, subdiv);
  clearLog(); log(`▶ Cycle ${r.cycle} = Step ${r.step} @ ${r.tempo} = segs [${r.segments}] = subdiv=${subdiv}`);

  let tickCount = 0;
  beatTimer = setInterval(()=>{
    tickCount++;
    const isMain = ((tickCount-1) % subdiv) === 0;
    if(isMain){
      if(byId('pulseToggle').checked){
        const pulseEl = document.getElementById('pulse');
        pulseEl.classList.remove('boom'); void pulseEl.offsetWidth; pulseEl.classList.add('boom');
      }
      const delay = Math.max(0, alignMs - onsetMainMs);
      if(delay>0) setTimeout(()=>playBuf(mainBuf), delay); else playBuf(mainBuf);
    } else {
      const delay = Math.max(0, alignMs - onsetSubMs);
      if(delay>0) setTimeout(()=>playBuf(subBuf), delay); else playBuf(subBuf);
    }
  }, interval);
}
function stopAll(){ if(beatTimer) clearInterval(beatTimer); beatTimer = null; log("⏹ Stopped."); }
async function start(){
  await ensureAudio();
  isStarted = true;
  updateStartStopUI();
  playCurrent(); // now Start actually plays
}

function updateStartStopUI(){
  var btn = byId('startStopBtn');
  var gen = byId('gen');
  if(btn){
    btn.textContent = (isStarted ? 'Stop' : 'Start');
    btn.classList.add('acc');
    btn.classList.remove('ghost');
    btn.setAttribute('aria-pressed', isStarted ? 'true' : 'false');
  }
  if(gen){
    gen.classList.add('ghost');
    gen.classList.remove('acc');
    if(isStarted){
      gen.disabled = true;
      gen.setAttribute('aria-disabled','true');
    } else {
      gen.disabled = false;
      gen.setAttribute('aria-disabled','false');
    }
  }
}

function stop(){ stopAll(); isStarted = false; updateStartStopUI(); }
function toggle(){ if(isStarted) stop(); else start(); }

// Keys
function keyNav(e){
  const el = e.target;
  const tag = (el && el.tagName || '').toLowerCase();
  const type = (el && el.type || '').toLowerCase();

  // Spacebar always controls transport, regardless of focus
  if (e.key === ' ' || e.code === 'Space') {
    // Prevent default so focused inputs (checkbox, number, range, select) don't hijack Space
    if (tag === 'select' || tag === 'textarea' || (tag === 'input' && (type === 'checkbox' || type === 'range' || type === 'number'))) {
      e.preventDefault();
      e.stopPropagation();
    }
    toggle();
    return;
  }

  // Arrow navigation unless composing or typing in a textarea (none here)
  if (e.isComposing) return;
  if (tag === 'textarea') return;

  if (e.key === 'ArrowDown'){ e.preventDefault(); nextStep(); }
  else if (e.key === 'ArrowUp'){ e.preventDefault(); prevStep(); }
  else if (e.key === 'ArrowLeft'){ e.preventDefault(); prevCycle(); }
  else if (e.key === 'ArrowRight'){ e.preventDefault(); nextCycle(); }
}

window.addEventListener('load', ()=>{ loadSettings(); applyTheme(); generate(); setEffectiveGainFromSlider(); scrollToTopStrong(); updateStartStopUI(); });
window.addEventListener('beforeunload', ()=>{ try{ saveSettings(); }catch(_){} });
window.addEventListener('keydown', keyNav, true);
window.addEventListener('keyup', keyUpBlock, true);

function keyUpBlock(e){
  const el = e.target;
  const tag = (el && el.tagName || '').toLowerCase();
  const type = (el && el.type || '').toLowerCase();
  if (e.key === ' ' || e.code === 'Space'){
    if (tag === 'select' || (tag === 'input' && (type === 'checkbox' || type === 'range' || type === 'number'))) {
      e.preventDefault();
      e.stopPropagation();
    }
  }
}


// Force-safe defaults on every open
window.addEventListener('load', ()=>{
  try{
    const vol = document.getElementById('volume');
    const volVal = document.getElementById('volVal');
    if (vol){ vol.value = 50; }
    if (volVal){ volVal.textContent = '50'; }
    const allow = document.getElementById('allowFullVolume');
    if (allow){ allow.checked = false; }
    // Update gain display/state
    try{
      if (typeof setEffectiveGainFromSlider === 'function'){ setEffectiveGainFromSlider(); }
      else if (typeof masterGain !== 'undefined' && masterGain){ masterGain.gain.value = 0.5; }
    }catch(_){}
  }catch(_){}
});


window.addEventListener('resize', ()=>{ placeLegendMobile(); });

</script>
</body>
</html>
